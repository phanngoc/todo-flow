name: ðŸ” Code Review

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      commit_range:
        description: 'Number of commits to review'
        required: false
        default: '1'
        type: string

env:
  CODE_RV_VERSION: "0.2.0"
  CODE_RV_REPO: "phanngoc/code-rv"

jobs:
  code-review:
    name: ðŸ” AI Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff analysis

      - name: ðŸ“¦ Download code-rv binary
        run: |
          echo "ðŸ“¥ Downloading code-rv pre-built binary..."
          # Try to download from release first
          DOWNLOAD_URL="https://github.com/${CODE_RV_REPO}/releases/download/v${CODE_RV_VERSION}/code-rv-linux-x64.tar.gz"
          
          if curl -fsSL -o code-rv.tar.gz "$DOWNLOAD_URL" 2>/dev/null; then
            echo "âœ… Downloaded from release"
            tar -xzf code-rv.tar.gz
            chmod +x code-rv-linux-x64
            sudo mv code-rv-linux-x64 /usr/local/bin/code-rv
          else
            echo "âš ï¸ Release not found, building from source..."
            # Fallback: Setup Rust and build
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source "$HOME/.cargo/env"
            
            curl -fsSL "https://github.com/${CODE_RV_REPO}/archive/refs/tags/v${CODE_RV_VERSION}.tar.gz" | tar -xz
            cd code-rv-*
            cargo build --release
            sudo cp target/release/code-rv /usr/local/bin/
          fi
          
          code-rv --version

      - name: ðŸŒ Install GitLab Knowledge Graph (GKG)
        run: |
          echo "ðŸ“¥ Installing GKG for code graph analysis..."
          curl -fsSL https://gitlab.com/gitlab-org/rust/knowledge-graph/-/raw/main/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"
          gkg --version

      - name: ðŸ—„ï¸ Start GKG Server & Index Project
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          # Index the project FIRST (before server starts)
          echo "ðŸ“Š Indexing project for code graph analysis..."
          gkg index .
          
          echo "ðŸš€ Starting GKG server in background..."
          gkg server start --detached
          
          # Wait for server to be ready
          echo "â³ Waiting for GKG server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:27495/api/info > /dev/null 2>&1; then
              echo "âœ… GKG server is ready!"
              break
            fi
            sleep 1
          done
          
          echo "âœ… GKG setup complete!"

      - name: ðŸ” Run Code Review (PR)
        if: github.event_name == 'pull_request'
        id: review-pr
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ“Š Reviewing PR changes..."
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "ðŸ” Comparing: ${BASE_SHA}..${HEAD_SHA}"
          
          # Run review and capture output
          REVIEW_OUTPUT=$(code-rv review \
            --path . \
            --from "${BASE_SHA}" \
            --to "${HEAD_SHA}" \
            --output markdown \
            2>&1) || true
          
          # Save output to file for comment
          echo "${REVIEW_OUTPUT}" > review-output.md
          
          # Also print to console
          echo "${REVIEW_OUTPUT}"

      - name: ðŸ” Run Code Review (Push)
        if: github.event_name == 'push'
        id: review-push
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ“Š Reviewing latest commits..."
          
          # Get before/after commits
          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"
          
          # Handle initial push (before is all zeros)
          if [[ "${BEFORE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
            BEFORE_SHA="${AFTER_SHA}~1"
          fi
          
          echo "ðŸ” Comparing: ${BEFORE_SHA}..${AFTER_SHA}"
          
          # Run review
          REVIEW_OUTPUT=$(code-rv review \
            --path . \
            --from "${BEFORE_SHA}" \
            --to "${AFTER_SHA}" \
            --output markdown \
            2>&1) || true
          
          echo "${REVIEW_OUTPUT}" > review-output.md
          echo "${REVIEW_OUTPUT}"

      - name: ðŸ” Run Code Review (Manual)
        if: github.event_name == 'workflow_dispatch'
        id: review-manual
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          COMMIT_RANGE="${{ github.event.inputs.commit_range }}"
          echo "ðŸ“Š Reviewing last ${COMMIT_RANGE} commit(s)..."
          
          REVIEW_OUTPUT=$(code-rv review \
            --path . \
            --from "HEAD~${COMMIT_RANGE}" \
            --to HEAD \
            --output markdown \
            2>&1) || true
          
          echo "${REVIEW_OUTPUT}" > review-output.md
          echo "${REVIEW_OUTPUT}"

      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let reviewOutput = '';
            
            try {
              reviewOutput = fs.readFileSync('review-output.md', 'utf8');
            } catch (e) {
              reviewOutput = 'âš ï¸ Failed to generate review output';
            }
            
            // Truncate if too long (GitHub comment limit is 65536 chars)
            const maxLength = 60000;
            if (reviewOutput.length > maxLength) {
              reviewOutput = reviewOutput.substring(0, maxLength) + '\n\n... (output truncated)';
            }
            
            const body = `## ðŸ” Code Review Results
            
            ${reviewOutput}
            
            ---
            *Automated review by [code-rv](https://github.com/sun-asterisk/engineer-excellence/tree/main/code-rv-app)*`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ” Code Review Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: ðŸ“Š Upload Review Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report
          path: review-output.md
          retention-days: 30

      - name: ðŸ›‘ Stop GKG Server
        if: always()
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          if command -v gkg &> /dev/null; then
            echo "ðŸ›‘ Stopping GKG server..."
            gkg server stop || true
          fi

  static-analysis-only:
    name: ðŸ“‹ Static Analysis (No AI)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Download code-rv binary
        run: |
          echo "ðŸ“¥ Downloading code-rv pre-built binary..."
          DOWNLOAD_URL="https://github.com/${CODE_RV_REPO}/releases/download/v${CODE_RV_VERSION}/code-rv-linux-x64.tar.gz"
          
          if curl -fsSL -o code-rv.tar.gz "$DOWNLOAD_URL" 2>/dev/null; then
            echo "âœ… Downloaded from release"
            tar -xzf code-rv.tar.gz
            chmod +x code-rv-linux-x64
            sudo mv code-rv-linux-x64 /usr/local/bin/code-rv
          else
            echo "âš ï¸ Release not found, building from source..."
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source "$HOME/.cargo/env"
            
            curl -fsSL "https://github.com/${CODE_RV_REPO}/archive/refs/tags/v${CODE_RV_VERSION}.tar.gz" | tar -xz
            cd code-rv-*
            cargo build --release
            sudo cp target/release/code-rv /usr/local/bin/
          fi
          
          code-rv --version

      - name: ðŸŒ Install GitLab Knowledge Graph (GKG)
        run: |
          echo "ðŸ“¥ Installing GKG for code graph analysis..."
          curl -fsSL https://gitlab.com/gitlab-org/rust/knowledge-graph/-/raw/main/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"
          gkg --version

      - name: ðŸ—„ï¸ Start GKG Server & Index Project
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          # Index the project FIRST (before server starts)
          echo "ðŸ“Š Indexing project..."
          gkg index .
          
          echo "ðŸš€ Starting GKG server in background..."
          gkg server start --detached
          
          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s http://localhost:27495/api/info > /dev/null 2>&1; then
              echo "âœ… GKG server is ready!"
              break
            fi
            sleep 1
          done

      - name: ðŸ“‹ Run Static Analysis
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          code-rv review \
            --path . \
            --from "${BASE_SHA}" \
            --to "${HEAD_SHA}" \
            --no-ai \
            --output terminal

      - name: ðŸ›‘ Stop GKG Server
        if: always()
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          if command -v gkg &> /dev/null; then
            gkg server stop || true
          fi
