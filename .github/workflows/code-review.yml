name: üîç Code Review

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      commit_range:
        description: 'Number of commits to review'
        required: false
        default: '1'
        type: string

env:
  CODE_RV_VERSION: "0.2.0"

jobs:
  code-review:
    name: üîç AI Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff analysis

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install code-rv from source
        run: |
          echo "üì• Downloading code-rv source..."
          curl -fsSL https://github.com/phanngoc/code-rv/archive/refs/tags/v${CODE_RV_VERSION}.tar.gz | tar -xz
          echo "üìÇ Listing extracted contents..."
          ls -la
          cd code-rv-*
          echo "üìÇ Current directory: $(pwd)"
          ls -la
          echo "üì¶ Installing dependencies..."
          npm install
          echo "üî® Building..."
          npm run build
          echo "üì¶ Installing globally..."
          npm link
          code-rv --version

      - name: üîç Run Code Review (PR)
        if: github.event_name == 'pull_request'
        id: review-pr
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üìä Reviewing PR changes..."
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "üîç Comparing: ${BASE_SHA}..${HEAD_SHA}"
          
          # Run review and capture output
          REVIEW_OUTPUT=$(code-rv review \
            --path . \
            --from "${BASE_SHA}" \
            --to "${HEAD_SHA}" \
            --output markdown \
            2>&1) || true
          
          # Save output to file for comment
          echo "${REVIEW_OUTPUT}" > review-output.md
          
          # Also print to console
          echo "${REVIEW_OUTPUT}"

      - name: üîç Run Code Review (Push)
        if: github.event_name == 'push'
        id: review-push
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üìä Reviewing latest commits..."
          
          # Get before/after commits
          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"
          
          # Handle initial push (before is all zeros)
          if [[ "${BEFORE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
            BEFORE_SHA="${AFTER_SHA}~1"
          fi
          
          echo "üîç Comparing: ${BEFORE_SHA}..${AFTER_SHA}"
          
          # Run review
          REVIEW_OUTPUT=$(code-rv review \
            --path . \
            --from "${BEFORE_SHA}" \
            --to "${AFTER_SHA}" \
            --output markdown \
            2>&1) || true
          
          echo "${REVIEW_OUTPUT}" > review-output.md
          echo "${REVIEW_OUTPUT}"

      - name: üîç Run Code Review (Manual)
        if: github.event_name == 'workflow_dispatch'
        id: review-manual
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          COMMIT_RANGE="${{ github.event.inputs.commit_range }}"
          echo "üìä Reviewing last ${COMMIT_RANGE} commit(s)..."
          
          REVIEW_OUTPUT=$(code-rv review \
            --path . \
            --from "HEAD~${COMMIT_RANGE}" \
            --to HEAD \
            --output markdown \
            2>&1) || true
          
          echo "${REVIEW_OUTPUT}" > review-output.md
          echo "${REVIEW_OUTPUT}"

      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let reviewOutput = '';
            
            try {
              reviewOutput = fs.readFileSync('review-output.md', 'utf8');
            } catch (e) {
              reviewOutput = '‚ö†Ô∏è Failed to generate review output';
            }
            
            // Truncate if too long (GitHub comment limit is 65536 chars)
            const maxLength = 60000;
            if (reviewOutput.length > maxLength) {
              reviewOutput = reviewOutput.substring(0, maxLength) + '\n\n... (output truncated)';
            }
            
            const body = `## üîç Code Review Results
            
            ${reviewOutput}
            
            ---
            *Automated review by [code-rv](https://github.com/sun-asterisk/engineer-excellence/tree/main/code-rv-app)*`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üîç Code Review Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: üìä Upload Review Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report
          path: review-output.md
          retention-days: 30

  static-analysis-only:
    name: üìã Static Analysis (No AI)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Download code-rv
        run: |
          curl -fsSL -o code-rv-linux-x64.tar.gz \
            "https://github.com/sun-asterisk/engineer-excellence/releases/download/code-rv-v${CODE_RV_VERSION}/code-rv-linux-x64.tar.gz" \
            || exit 0
          tar -xzf code-rv-linux-x64.tar.gz 2>/dev/null || exit 0
          chmod +x code-rv-linux-x64 2>/dev/null || exit 0
          sudo mv code-rv-linux-x64 /usr/local/bin/code-rv 2>/dev/null || exit 0

      - name: üìã Run Static Analysis
        run: |
          if command -v code-rv &> /dev/null; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            
            code-rv review \
              --path . \
              --from "${BASE_SHA}" \
              --to "${HEAD_SHA}" \
              --no-ai \
              --output terminal
          else
            echo "‚ö†Ô∏è code-rv not available, skipping static analysis"
          fi
